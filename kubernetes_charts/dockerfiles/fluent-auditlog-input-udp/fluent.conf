# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/fluent.conf.erb

@include conf.d/*.conf

<system>
 workers 3
</system>

<source>
  @type udp
  tag "#{ENV['FLUENTD_TAG']}"
  port "#{ENV['FLUENTD_PORT']}"
  bind 0.0.0.0
  message_length_limit 10MB
  <parse>
    @type json
  </parse>
</source>


<match app-metrics>
  @type kafka2
  @log_level info

  brokers "#{ENV['FLUENT_KAFKA_BROKERS']}"

  default_topic "#{ENV['FLUENT_KAFKA_DEFAULT_TOPIC'] || nil}"
  # default_partition_key "#{ENV['FLUENT_KAFKA_DEFAULT_PARTITION_KEY'] || nil}"
  # default_message_key "#{ENV['FLUENT_KAFKA_DEFAULT_MESSAGE_KEY'] || nil}"
  exclude_topic_key "#{ENV['FLUENT_KAFKA_EXCLUDE_TOPIC_KEY'] || false}"
  exclude_partition_key "#{ENV['FLUENT_KAFKA_EXCLUDE_PARTITION_KEY'] || false}"
  get_kafka_client_log "#{ENV['FLUENT_KAFKA_GET_KAFKA_CLIENT_LOG'] || true}"
  kafka_agg_max_bytes 8192
  kafka_agg_max_messages 10000

  <format>
   @type json
  </format>

  <buffer topic>
   @type file
   path /var/log/td-agent/buffer/td
   flush_interval 1s
   compress gzip
   flush_at_shutdown true
   flush_mode interval
   overflow_action drop_oldest_chunk
   retry_timeout 5m
  </buffer>

  # ruby-kafka producer options
  max_send_retries "#{ENV['FLUENT_KAFKA_MAX_SEND_RETRIES'] || 3}"
  required_acks "#{ENV['FLUENT_KAFKA_REQUIRED_ACKS'] || 1}"
  ack_timeout "#{ENV['FLUENT_KAFKA_ACK_TIMEOUT'] || 3 }"
  # compression_codec "#{ENV['FLUENT_KAFKA_COMPRESSION_CODEC'] || 'gzip' }"
  # max_send_limit_bytes "#{ENV['FLUENT_KAFKA_MAX_SEND_LIMIT_BYTES'] || 1000000}"
  # discard_kafka_delivery_failed "#{ENV['FLUENT_KAFKA_DISCARD_KAFKA_DELIVERY_FAILED'] || false }"
</match>

